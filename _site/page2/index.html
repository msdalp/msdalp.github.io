<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="UTF-8">
  <link href="http://gmpg.org/xfn/11" rel="profile">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      msdalp &middot; java, android, etc.
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-89611351-1', 'auto');
  ga('send', 'pageview');

</script>
  <!-- RSS -->
  <link rel="alternate" type="application/atom+xml" title="msdalp" href="/atom.xml">
</head>


  <body>

    <div class="container content">
      <header class="masthead">
      <h3 class="masthead-title">
<a href="/" title="Home">msdalp</a>
<small>java, android, etc.</small>

  &nbsp;&nbsp;&nbsp;
  <small><a href="/about">About</a></small>

  &nbsp;&nbsp;&nbsp;
  <small><a href="/archive">Archive</a></small>

  &nbsp;&nbsp;&nbsp;
  <small><a href="/atom.xml">Feed</a></small>


</h3>

      </header>

      <main>
        <div class="posts">
  
  <article class="post">
    <h1 class="post-title">
      <a href="/2016/01/03/Java-Jersey-Rest-Hello/">
        Rest API Example with Java Jersey and Tomcat 
      </a>
    </h1>

    <time datetime="2016-01-03T11:43:32+01:00" class="post-date">03 Jan 2016</time>

    The definition of the Jersey framework from their website:

Jersey framework is more than the JAX-RS Reference Implementation. Jersey provides itâ€™s own API that extend the JAX-RS toolkit with additional features and utilities to further simplify RESTful service and client development. Jersey also exposes numerous extension SPIs so that developers may extend Jersey to best suit their needs.

You can read details from <a href="https://jersey.java.net">https://jersey.java.net</a>

What I will try to show is creating a project from beginning and put more in time to make it a whole complete structure in this order:

 - Create a project by using HTTP methods.
 - Add database connection to the project and Authentication (tokens, roles)
 - Add error mappings, logging requests and responses
 - Jackson specific settings

I will be using Netbeans 8, Tomcat 7, Jersey 2.9.1, and Java 7.

Firstly create a new project by selecting Maven Web project.

![new project ss](/assets/img/new_maven_project.png)<br>

After creating your project add dependencies as given below and we will be adding other dependencies when it is needed.
{% highlight xml %}
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <groupId>com.jersey.test</groupId>
    <artifactId>JerseyTest</artifactId>
    <version>1.0-SNAPSHOT</version>
    <packaging>war</packaging>

    <name>JerseyTest</name>

    <properties>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
    </properties>

    <dependencies>
        <dependency>
            <groupId>javax.servlet</groupId>
            <artifactId>javax.servlet-api</artifactId>
            <version>3.1.0</version>
            <scope>provided</scope>
        </dependency>
        <dependency>
            <groupId>log4j</groupId>
            <artifactId>log4j</artifactId>
            <version>1.2.17</version>
        </dependency>
        <dependency>
            <groupId>org.glassfish.jersey.containers</groupId>
            <artifactId>jersey-container-servlet</artifactId>
            <version>2.9.1</version>
        </dependency>
        <dependency>
            <groupId>org.glassfish.jersey.media</groupId>
            <artifactId>jersey-media-json-jackson</artifactId>
            <version>2.22.1</version>
        </dependency>

    </dependencies>
    <build>
        <finalName>JerseyTest</finalName>
        <plugins>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-war-plugin</artifactId>
                <version>2.6</version>
            </plugin>

            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-compiler-plugin</artifactId>
                <version>3.5.1</version>
                <configuration>
                    <source>1.7</source>
                    <target>1.7</target>
                </configuration>
            </plugin>

        </plugins>
    </build>

</project>
{% endhighlight %}

Jersey provides an abstract class Application declaring root resource and provider classes, and root resource and provider singleton instances. A Web service may extend this class to declare root resource and provider classes.

Alternatively it is possible to reuse ResourceConfig - Jersey's own implementations of Application class that we will be using.

Simply you give the packages that you want to include in the project for deployment and register the properties like JSON and GZIP. Also you can register filters, singletons and other things as well.


{% highlight java %}
package com.jersey.test.app;

import javax.ws.rs.ApplicationPath;
import org.glassfish.jersey.jackson.JacksonFeature;
import org.glassfish.jersey.server.ResourceConfig;

/**
 *
 * @author Mustafa Alparslan <msdalp.github.io>
 */
@ApplicationPath("")
public class RestApp extends ResourceConfig {
    public RestApp() {
        packages(new String[]{
            "com.jersey.test.data"
        });
        register(JacksonFeature.class);
    }
}
{% endhighlight %}

At this stage if your IDE is giving error about web.xml or context.xml then simply put these files and will be used in the future posts.

web.xml
{% highlight xml %}
<?xml version="1.0" encoding="UTF-8"?>
<web-app version="3.1" xmlns="http://xmlns.jcp.org/xml/ns/javaee"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd">

</web-app>
{% endhighlight %}
context.xml
{% highlight xml %}
<?xml version="1.0" encoding="UTF-8"?>
<Context antiJARLocking="true" path="/JerseyTest"/>
{% endhighlight %}

The package I included in the main class was "com.jersey.test.data" and for the sake of simplicity I will add User model and the Users service to show methods.

These two classes have no specific property (user model and a map to put users inside while we have no database connection).
{% highlight java %}
package com.jersey.test.data;

/**
 *
 * @author Mustafa Alparslan <msdalp.github.io>
 */
public class User {
    public long id;
    public String name;
    public String password;

    public User() {
    }

    public User(long id, String name, String password) {
        this.id = id;
        this.name = name;
        this.password = password;
    }
}
{% endhighlight %}

{% highlight java %}
package com.jersey.test.app;

import com.jersey.test.data.User;
import java.util.HashMap;
import java.util.Map;

/**
 *
 * @author Mustafa Alparslan <msdalp.github.io>
 */
public class Data {

    public static Map<Long,User> users = new HashMap<>();

}
{% endhighlight %}




{% highlight java %}
package com.jersey.test.data;

import com.jersey.test.app.Data;
import javax.servlet.ServletContext;
import javax.servlet.http.HttpServletRequest;
import javax.ws.rs.Consumes;
import javax.ws.rs.DELETE;
import javax.ws.rs.GET;
import javax.ws.rs.POST;
import javax.ws.rs.PUT;
import javax.ws.rs.Path;
import javax.ws.rs.PathParam;
import javax.ws.rs.Produces;
import javax.ws.rs.core.Context;
import javax.ws.rs.core.MediaType;
import javax.ws.rs.core.Response;

/**
 *
 * @author Mustafa Alparslan <msdalp.github.io>
 */
@Path("/users")
public class Users {

    @Context
    ServletContext servletContext;
    @Context
    HttpServletRequest servletRequest;

    @Produces({MediaType.APPLICATION_JSON})
    @Path("{userId}")
    @GET
    public Response processGet(@PathParam("userId") Long userId) {
        if (Data.users.containsKey(userId)) {
            return Response.status(Response.Status.OK)
                    .entity(Data.users.get(userId)).type("application/json").build();
        } else {
            return Response.status(Response.Status.NOT_FOUND)
                    .entity(new Msg(Msg.Cond.error, "Not Found")).type("application/json").build();
        }
    }

    @Produces({MediaType.APPLICATION_JSON})
    @Path("{userId}")
    @DELETE
    public Response processDel(@PathParam("userId") long userId) {
        if (Data.users.containsKey(userId)) {
            Data.users.remove(userId);
            return Response.status(Response.Status.OK)
                    .entity(new Msg(Msg.Cond.success, "Operation successful")).type("application/json").build();
        } else {
            return Response.status(Response.Status.NOT_FOUND)
                    .entity(new Msg(Msg.Cond.error, "Not Found")).type("application/json").build();
        }
    }

    @Consumes(MediaType.APPLICATION_JSON)
    @Produces({MediaType.APPLICATION_JSON})
    @Path("")
    @POST
    public Response processAdd(User user) {
        Data.users.put(user.id, user);
        return Response.status(Response.Status.OK)
                .entity(Data.users.values()).type("application/json").build();
    }

    @Consumes(MediaType.APPLICATION_JSON)
    @Produces({MediaType.APPLICATION_JSON})
    @Path("")
    @PUT
    public Response processUpdate(User user) {
        Data.users.put(user.id, user);
        return Response.status(Response.Status.OK)
                .entity(Data.users.values()).type("application/json").build();
    }

}
{% endhighlight %}

Your service definition starts with a "@Path("/users")" annotation which defines the root path of the class. You can add more lower levels before the methods like "@Path("{userId}/orders")" which will take user id as parameter and return the orders of that user. However be aware that adding conflicting classes will broke the URL schema and calling these URLs will give some runtime Exceptions.

You define the name of HTTP method with annotations  as well (by using @GET, @POST, @PUT, @DELETE).

For the requests with @GET and @DELETE methods PathParam (directly in url like /users/14) or QueryParam (by using ? and values behind like /users?id=14) can be used (together or only one of them). However I highly recommend that if it is a REST-API then use PathParams to make it more readable.

Also you should read about REST a bit from
<a href="http://stackoverflow.com/questions/671118/what-exactly-is-restful-programming"> this stackoverflow link</a>. Honestly I don't care about the talk 'your api should match 100% to the rules otherwise your api is not a rest' crap. The main idea is creating a standard that allows developers (for both server and client side) to make their jobs with ease. At the end call your api 'like REST' and then everyone will be happy.

Even though I said that is not important but at least you should be able to provide these properties.

- Proper url naming: It is quite easy and important thing since creating urls properly would make much easier to use you API.

Please do not use sentences at the urls and at least it should match the form of

{% highlight bash %}
/users -> to add or update the user
/users/{userId} -> to get or delete the user
/users/{userId}/orders -> to get the orders of the user
{% endhighlight %}

- Proper usage of HTTP methods:

It should use @GET to retrieve data, @POST-@PUT to add and update data, and @DELETE to delete data. It may change with the specific methods but using this in your main models should be quite easy.

- Proper usage of HTTP Codes:

It is quite important to send proper HTTP Codes in your responses. It would be much easier to manage to responses and take action according to these codes (like if the code is 401 and can not refresh token then redirect to the login page). Again there are many codes but:

{% highlight bash %}
200 -> successful request
400 -> bad request
401 -> auth is not valid or expired
403 -> forbidden
500 -> internal error
{% endhighlight %}

- Security with Auth Token and others if more needed (like JWT)
- Proper request responses and errors  


I will continue the REST specifications in another post and return to the JERSEY.

For the requests with @POST and @PUT methods FormParam (like usual form parameter with username=msd&password=alp) or directly the object representation of request as it is used in the example (User user). However you must define the '    @Consumes(MediaType.APPLICATION_JSON)' annotation for the method.

Also you may notice that some methods use the same path. Separation of unique methods are done by classical java method name and parameters on the compile time,  path and http method on the runtime. Therefore you can define two methods with the same path and parameter but different HTTP method (GET or DELETE).

@Produces({MediaType.APPLICATION_JSON}) annotation takes a list of MediaType (or string like 'application/json') that defines the possible return types. It is possible to use two different response type in one method like
{% highlight java %}
     @Produces({MediaType.APPLICATION_JSON, MediaType.APPLICATION_XML})
{% endhighlight %}

This is all the things you need for a simple project. I will be adding Redis, PostgreSQL, and Mysql for data access and caching in the next posts.

  </article>
  
  <article class="post">
    <h1 class="post-title">
      <a href="/2015/06/27/Understanding-innodb_buffer_pool_size/">
        Understanding innodb_buffer_pool_size
      </a>
    </h1>

    <time datetime="2015-06-27T23:54:22+02:00" class="post-date">27 Jun 2015</time>

    There are lots of parameters when you try to optimize your mysql but the most important one is Innodb Buffer Pool. It is defined as %70 of the your server total RAM but we need more details. Let's first check the definition given from MYSQL:

> InnoDB maintains a storage area called the buffer pool for caching data and indexes in memory. Knowing how the InnoDB buffer > pool works, and taking advantage of it to keep frequently accessed data in memory, is an important aspect of MySQL tuning.

The idea is keeping innodb_buffer_pool_size bigger as possible that doesn't block other OS and programs running properly. This will make InnoDB work like a in-memory database and increase the performance a lot. At first InnoDB will take all the required data from disk and access it from memory in the future queries. The default value for InnoDB is 8MB so you might want to update it as a bigger number which fits well for your system.

Before going exact details there is a wrong assumption about Innodb Buffer Pool. People think that if they give enough space for keys to be in the memory and there will be very low IO accesss. The idea is searching keys fast as much as and retrieve data with index directly. Let's assume you have a query that runs in 600ms and 450 ms is searching keys, 75 ms is getting data from disk and last 75 ms is fetching data from server. Providing proper innodb_buffer_pool_size will make sure you don't access disk for index search and that 450 ms will decrease to 30 ms (it really depends on your keys and structure) so total time for query is 180 ms now. You still have IO at this rate but it is only retrieving data from disk which can be acceptable.

I will not get into details how InnoDB manages the pool and LRU algorithm but directly give info about what value we should choose. Run this query to get an recommended memory:
{% highlight sql %}
SELECT CONCAT(ROUND(KBS/POWER(1024,
IF(PowerOf1024<0,0,IF(PowerOf1024>3,0,PowerOf1024)))+0.49999),
SUBSTR(' KMG',IF(PowerOf1024<0,0,
IF(PowerOf1024>3,0,PowerOf1024))+1,1)) recommended_innodb_buffer_pool_size
FROM (SELECT SUM(data_length+index_length) KBS FROM information_schema.tables
WHERE engine='InnoDB') A,
(SELECT 3 PowerOf1024) B;
{% endhighlight %}
In my system it returns the value:
{% highlight sql %}
recommended_innodb_buffer_pool_size
48G
{% endhighlight %}
Be careful with these values since InnoDB reserves additional memory for buffers and control structures, so that the total allocated space is approximately 10% greater than the specified size. When you have 50 GB RAM and you give 48GB as pool, you will probably get OS paging problems.

This is a simple value that you should better have this value to reach all data properly with the help of Innodb Buffer Pool. Let's assume you set the value 45GB and you want to make sure that these resources are not wasted and buffer pool is used. At this point we should check the buffer pool usage value. It must be run after the all the heavy operations are done for your system. If your system is on high load only on weekends then you should wait for the run this query at least one or two week so you would get at least a minimal idea how the system will respond on load.
{% highlight sql %}
SELECT (PagesData*PageSize)/POWER(1024,3) DataGB FROM
(SELECT variable_value PagesData
FROM information_schema.global_status
WHERE variable_name='Innodb_buffer_pool_pages_data') A,
(SELECT variable_value PageSize
FROM information_schema.global_status
WHERE variable_name='Innodb_page_size') B;
{% endhighlight %}
For my system it returns:
{% highlight sql %}
DataGB
22.5G
{% endhighlight %}
It might be %100 (45G) or some other value depending on the system and you should take action according to this value. It means that even though your system has 45GB of indices you only access 22GB of it at this time area. Hence lowering the value as 25GB should be okay the system to run at almost the same performance. However be careful with the value and keep observing the value for some time and make sure it doesn't go up quickly after for a week etc.

There are some other parameters that needed to be adjusted as well but I will not get into these details. Let's assume you run the query for recommended buffer pool and you got 11GB. However you only have 11.5GB data in your database and it seems a bit odd to have such a big number. The reason for this you probably have too much or redundant index for your tables. You should reconsider the indices and adjust them to a proper state which doesn't make your operations slower and reserve so much space.

One other issue primary keys of very big tables. Let's say we have 20 tables with average 1 million to 5 million rows data but only two of them have 200 million rows data per table. At total you should have 450 million rows and probably with indices it would require around 50GB inno db pool. If you don't access these tables heavily or they are accessed by a big group (like 1.5 million records of logs  belong to one operation) then you should not need a really big buffer pool. However a small amount of pool will be filled with one group data easily and other operations become slower at that time. At least try to give a proper amount of memory to handle the one big operation and it's additional queries. Of course it is totally another discussion topic why don't you use some other systems (Cassandra or a different NOSQL maybe ) to store big tables to create results and put these values into mysql to be access etc.

To sum up; run the query and get a recommended value for your innodb_buffer_pool_size. If you think it is enormous for your database then try to optimize your indices and lower the number of key values. Also be careful with the very high values since it might throttle the system and cause bigger problems like uptimes. Also check other parameters to use the memory you attached more efficiently.

  </article>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page3">Older</a>
  
  
    
      <a class="pagination-item newer" href="/">Newer</a>
    
  
</div>


      </main>
      <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    // Required: on line below, replace text in quotes with your forum shortname
    var disqus_shortname = 'msdalp';
    // var disqus_developer = 1;

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

      <footer class="footer">
        <small>
          &copy; <time datetime="2018-04-16T19:53:39+02:00">2018</time>. All rights reserved.
        </small>
      </footer>
    </div>

  </body>
</html>
